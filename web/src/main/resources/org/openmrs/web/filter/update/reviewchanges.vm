#parse($HEADER_TEMPLATE)
<link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/notyf@3/notyf.min.css"/>
<script src="https://cdn.jsdelivr.net/npm/notyf@3/notyf.min.js"></script>
<script>
    const notyf = new Notyf({
        duration: 5000,
        ripple: true,
        position: {
            x: 'right',
            y: 'top'
        },
        types: [
            {
                type: 'success',
                background: '#246b63',
                icon: {
                    className: 'fas fa-check',
                    tagName: 'i',
                    text: ''
                }
            }, {
                type: 'error',
                background: '#d32f2f',
                icon: {
                    className: 'fas fa-times',
                    tagName: 'i',
                    text: ''
                }
            }, {
                type: 'warning',
                background: '#f9a825',
                icon: {
                    className: 'fas fa-exclamation-triangle',
                    tagName: 'i',
                    text: ''
                }
            }
        ]
    });

    var lastIndex = 0;
    var numberUnsuccessfulJQueryAttempts = 0;
    var isDisplayingWarnings = false;
    var hasShownSuccessToast = false;

    // schedule the next update check first so we're sure it happens (in case an error occurs) only
    // check the server again if the last post was successful (assumes checking the server takes less
    // than 1 second)
    function showProgress() {
        if (numberUnsuccessfulJQueryAttempts < 5) {
            setTimeout("showProgress()", 1000);
            numberUnsuccessfulJQueryAttempts += 1; // this is to be reset in the jquery.post success func callback
        } else {
            notyf.error("Too many failed attempts. Redirecting...");
            setTimeout(() => window.location = "index.htm", 3000);
            return;
        }

        jQuery.post("${setupPageUrl}", {
            page: "updateProgress.vm.ajaxRequest"
        }, function (data) {
            numberUnsuccessfulJQueryAttempts = 0;

            // jQuery("#log").html(jQuery("#log").html() + " in post method.");

            /*If we have any warnings from the database update, show them*/
            if (data && data.hasWarnings) {
                jQuery("#warningPane").show();
                jQuery("#warnings").html(data.updateWarnings);
                jQuery("#updateLogFile").html(data.updateLogFile);
                if (!isDisplayingWarnings) {
                    notyf.warning("Warnings detected during update.");
                    isDisplayingWarnings = true;
                }
            }

            if (data == null || !data.updatesRequired) {
                if (!isDisplayingWarnings && !hasShownSuccessToast) {
                    notyf.success("Database update completed successfully!");
                    jQuery("#successPane").show();
                    hasShownSuccessToast = true;
                }
                return;
            }

            if (data.hasErrors) {
                notyf.error("An error occurred. Reloading...");
                window.location = "${setupPageUrl}";
                return;
            }

            jQuery("#lastActionMessage").html(data.message);

            for (var x = lastIndex; x < data.changesetIds.length; x++) {
                let id = data.changesetIds[x];
                jQuery("#" + id + "loading").hide();
                jQuery("#" + id + "checkmark").show();
            }

            lastIndex = data.changesetIds.length - 1;
            jQuery("#" + data.executingChangesetId + "checkmark").hide();
            jQuery("#" + data.executingChangesetId + "loading").show();

            jQuery("#logLinesDiv").show();
            let log = "";
            for (let i = 0; i < data.logLines.length; i++) {
                log += data.logLines[i] + "<br/>";
            }
            jQuery("#logLines").html(log);
        }, "json");
    }

    #if($updateJobStarted == true)
    jQuery(function () {
        showProgress();
    });
    #end
</script>
<style>
    body {
        background-color: #f4f8fb;
        font-family: "Roboto", sans-serif;
    }

    .container {
        max-width: 720px;
        margin: 40px auto;
        background-color: #ffffff;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        padding: 30px;
    }

    .step-header {
        font-size: 20px;
        font-weight: bold;
        margin-bottom: 20px;
        text-align: center;
    }

    .notification {
        padding: 15px 20px;
        border-radius: 6px;
        margin-bottom: 20px;
    }

    .notification.success {
        background-color: #e6f4ea;
        color: #2e7d32;
        border: 1px solid #81c784;
    }

    .notification.warning {
        background-color: #fff3cd;
        color: #856404;
        border: 1px solid #ffeeba;
    }

    .update-table {
        width: 100%;
        table-layout: fixed;
        border-collapse: collapse;
        margin-bottom: 20px;
    }

    .update-table td,
    .update-table th {
        padding: 12px;
        border-bottom: 1px solid #ddd;
        text-align: left;
        vertical-align: top;
        word-wrap: break-word;
        overflow-wrap: break-word;
        word-break: break-word;
        white-space: normal;
    }

    .update-table td:nth-child(1),
    .update-table th:nth-child(1) {
        width: 5%;
    }

    .update-table td:nth-child(2),
    .update-table th:nth-child(2) {
        width: 40%;
    }

    .update-table td:nth-child(3),
    .update-table th:nth-child(3) {
        width: 40%;
    }

    .update-table td:nth-child(4),
    .update-table th:nth-child(4) {
        width: 15%;
    }

    .status-icon {
        width: 18px;
        height: 18px;
        vertical-align: middle;
    }

    .log-area {
        background-color: #f6f8fa;
        border-radius: 6px;
        padding: 15px;
        font-size: 14px;
        max-height: 200px;
        overflow-y: auto;
        border: 1px solid #ccc;
        white-space: pre-wrap;
        margin-bottom: 20px;
    }

    .button-group {
        text-align: center;
    }

    .button {
        background-color: #246B63;
        color: white;
        border: none;
        padding: 10px 25px;
        border-radius: 4px;
        font-size: 15px;
        cursor: pointer;
    }

    .text-center {
        text-align: center;
    }

    .last-message {
        font-style: italic;
        margin-top: 15px;
    }
</style>
<form method="post" autocomplete="off">
    <input type="hidden" name="page" value="reviewchanges.vm"/>
    <div class="container">
        <div class="step-header">
            #if($isDatabaseUpdateInProgress) $l10n.get("update.warn.anotherUser") #else #if ($updateJobStarted
            != true) $l10n.get("update.warn.updatesRequired") #else $l10n.get("update.warn.updatesExecuted")
            #end #end
            </div>
            <div id="warningPane" class="notification warning" style="display: none;">
                <strong>$l10n.get("update.warn")</strong><br/>
                $l10n.get("update.warn.saved")<br/>
                <div id="updateLogFile"></div>
                <div id="warnings"></div>
            </div>
            <div id="successPane" class="notification success" style="display: none;">
                Database update completed successfully! You may now continue.
            </div>
            <table class="update-table">
                <thead>
                    <tr>
                        <th></th>
                        <th>$l10n.get("update.review.desc")</th>
                        <th>$l10n.get("update.review.act")</th>
                        <th>$l10n.get("update.review.auth")</th>
                    </tr>
                </thead>
                <tbody>
                    #foreach ($change in $changes)
                        <tr>
                            <td>
                                <img
                                    id="${change.id}checkmark"
                                    src="images/checkmark.png"
                                    class="status-icon"
                                    style="display: none;"
                                    alt="Done"/>
                                <img
                                    id="${change.id}loading"
                                    src="images/loading.gif"
                                    class="status-icon"
                                    style="display: none;"
                                    alt="Running"/>
                            </td>
                            <td>${change.comments}</td>
                            <td>${change.description}</td>
                            <td>${change.author}</td>
                        </tr>
                    #end
                </tbody>
            </table>
            <div id="logLinesDiv" class="log-area" style="display: none;">
                <strong>$l10n.get("install.progress.server.log")</strong><br/>
                <div id="logLines"></div>
            </div>
            <div id="lastActionMessage" class="text-center last-message"></div>
            #if ($updateJobStarted != true && $isDatabaseUpdateInProgress != true)
                <div class="button-group">
                    <button id="continue" name="continue" class="button" type="submit">$l10n.get("general.continue")
                    </button>
                </div>
            #else
                <div class="button-group" style="margin-top: 20px;">
                    <button
                        id="continueButton"
                        class="button"
                        type="button"
                        onclick="window.location='index.htm'"
                    >
                        $l10n.get("general.continue")
                    </button>
                </div>
            #end
        </div>
    </form>
    #parse($FOOTER_TEMPLATE)
    